<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CoffeShopMAUI.ViewModels"
             xmlns:models="clr-namespace:CoffeShopMAUI.Models;assembly=CoffeShopMAUI.Core"
             x:Class="CoffeShopMAUI.Pages.OrderHistoryPage"
             x:DataType="vm:OrderHistoryViewModel"
             Title="Today's Orders">
    <RefreshView Command="{Binding LoadOrdersCommand}" IsRefreshing="{Binding IsBusy}">
        <CollectionView ItemsSource="{Binding Orders}">
            <CollectionView.EmptyView>
                <Label Text="No orders today"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       Padding="20"
                       TextColor="Gray" />
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Order">
                    <Border StrokeShape="RoundRectangle 12"
                            StrokeThickness="1"
                            Stroke="PaleGoldenrod"
                            Margin="8"
                            Padding="10">
                        <VerticalStackLayout Spacing="6">
                            <Label Text="{Binding CustomerName}" FontAttributes="Bold" />
                            <Label Text="{Binding OrderNumber}" FontSize="12" TextColor="Gray" />
                            <Label Text="{Binding CreatedAt, StringFormat='{}{0:MMM d, h:mm tt}'}" FontSize="12" TextColor="Gray" />
                            <Label Text="Items:" FontAttributes="Bold" />
                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Items}" Spacing="2">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:OrderLine">
                                        <Grid ColumnDefinitions="*, Auto, Auto" Padding="2">
                                            <Label Text="{Binding Name}" />
                                            <Label Grid.Column="1" />
                                            <Label Grid.Column="2" Text="{Binding LineTotal, StringFormat='€{0:N2}'}" />
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>
                            <Grid ColumnDefinitions="Auto, *" Margin="0,4,0,0">
                                <Label Text="Total:" FontAttributes="Bold" />
                                <Label Grid.Column="1"
                                       Text="{Binding TotalAmount, StringFormat='€{0:N2}'}"
                                       HorizontalOptions="End"
                                       FontAttributes="Bold" />
                            </Grid>
                        </VerticalStackLayout>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OrderHistoryViewModel}}, Path=ViewOrderCommand}"
                                                  CommandParameter="{Binding .}" />
                        </Border.GestureRecognizers>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </RefreshView>
</ContentPage>
